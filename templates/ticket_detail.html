{% extends 'base.html' %}

{% block content %}
<section class="card">
  <h2>Ticket #{{ ticket['id'] }}</h2>
  <div class="detail-grid">
    <div>
      <h3>Solicitante</h3>
      <p>{{ ticket['email_from'] }}</p>
    </div>
    <div>
      <h3>Técnico asignado</h3>
      <p>{{ ticket['assigned_to'] }}</p>
    </div>
    <div>
      <h3>Estado</h3>
      <p class="status {{ ticket['status']|lower|replace(' ', '-') }}">{{ ticket['status'] }}</p>
    </div>
    <div>
      <h3>Creado</h3>
      <p>{{ ticket['created_at'] }}</p>
    </div>
    <div>
      <h3>Cerrado</h3>
      <p>{{ ticket['closed_at'] or 'En progreso' }}</p>
    </div>
  </div>
  <h3>Asunto</h3>
  <p>{{ ticket['subject'] }}</p>
  <h3>Detalle</h3>
  <p>{{ ticket['body'] }}</p>

  {% if user.role == 'dispatcher' %}
  <form method="post" action="{{ url_for('assign_ticket', ticket_id=ticket['id']) }}">
    <label>
      Derivar a técnico
      <select name="technician_email" required>
        <option value="" disabled selected>Seleccionar técnico</option>
        {% for tech in technicians %}
        <option value="{{ tech['email'] }}">{{ tech['name'] }} - {{ tech['specialty'] }}</option>
        {% endfor %}
      </select>
    </label>
    <button type="submit">Asignar</button>
  </form>
  {% endif %}

  {% if user.role == 'technician' and user.technician_email == ticket['assigned_to'] %}
  <form method="post" action="{{ url_for('comment_ticket', ticket_id=ticket['id']) }}">
    <label>
      Comentario (opcional)
      <textarea name="comment" rows="3" placeholder="Detalle de la atención..."></textarea>
    </label>
    <button type="submit">Guardar comentario</button>
  </form>

  <form method="post" action="{{ url_for('reassign_ticket', ticket_id=ticket['id']) }}">
    <label>
      Derivar a otro técnico o devolver al derivador
      <select name="technician_email" required>
        <option value="" disabled selected>Seleccionar</option>
        <option value="dispatcher">Devolver al derivador</option>
        {% for tech in technicians %}
        {% if tech['email'] != ticket['assigned_to'] %}
        <option value="{{ tech['email'] }}">{{ tech['name'] }} - {{ tech['specialty'] }}</option>
        {% endif %}
        {% endfor %}
      </select>
    </label>
    <label>
      Motivo (opcional)
      <textarea name="note" rows="2" placeholder="Ej: Requiere especialista..."></textarea>
    </label>
    <button type="submit">Reasignar</button>
  </form>
  {% endif %}

  {% if ticket['status'] != 'Cerrado' and (user.role == 'admin' or (user.role == 'technician' and user.technician_email == ticket['assigned_to'])) %}
  <form method="post" action="{{ url_for('close_ticket', ticket_id=ticket['id']) }}">
    <button type="submit">Cerrar ticket</button>
  </form>
  {% endif %}
</section>

<section class="card">
  <h2>Seguimiento</h2>
  <ul class="timeline">
    {% for event in timeline %}
    <li>
      <span>{{ event['created_at'] }}</span>
      <strong>{{ event['event'] }}</strong>
    </li>
    {% else %}
    <li>No hay eventos registrados.</li>
    {% endfor %}
  </ul>
</section>
{% endblock %}
